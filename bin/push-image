#!/usr/bin/env sh

set -eu
[ "${TRACE:-}" = true ] && set -x

repo=$1
commit=$(git rev-parse --short=7 HEAD)
branch=$(git branch --show-current | sed 's/[^a-zA-Z0-9]/-/g')
tags=$(git tag --points-at HEAD | sed 's/[^a-zA-Z0-9]/-/g')

diff=$(git status --short --untracked-files=normal --)

#if [ "$diff" != "" ]; then
#  printf '\033[1;31mERROR: You have uncommitted changes - refusing to push:\033[0m\n'
#  echo "$diff"
#  exit 1
#fi

docker buildx inspect eg-builder >/dev/null 2>&1 || docker buildx create --name eg-builder --bootstrap

tag_args="-t $repo:$commit"
[ "$branch" = "main" ] && tag_args="$tag_args -t $repo:latest"
[ "$branch" != "" ] && tag_args="$tag_args -t $repo:$branch"

for tag in $tags; do
  tag_args="$tag_args -t $repo:$tag"
done

echo $AWS_PROFILE

docker buildx build --builder=eg-builder --platform linux/amd64,linux/arm64 --push \
  -f Dockerfile \
  $tag_args \
  .
